<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Nigo" />


    
    


<meta name="description" content="Just do it!">
<meta property="og:type" content="website">
<meta property="og:title" content="Nigo">
<meta property="og:url" content="http://githubdelegate.github.io/index.html">
<meta property="og:site_name" content="Nigo">
<meta property="og:description" content="Just do it!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nigo">
<meta name="twitter:description" content="Just do it!">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Nigo" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Nigo</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Nigo</a></h1>
        </hgroup>

        
        <p class="header-subtitle">take care of your time,man!</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/随笔">随笔</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/githubdelegate/" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/">FFmpeg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenglES/">OpenglES</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/video-FFmpeg/">video,FFmpeg</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Nigo</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Nigo</a></h1>
            </hgroup>
            
            <p class="header-subtitle">take care of your time,man!</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/随笔">随笔</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/githubdelegate/" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-OpenglES学习4-立方体" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/20/OpenglES学习4-立方体/" class="article-date">
      <time datetime="2017-10-20T11:30:50.000Z" itemprop="datePublished">2017-10-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/20/OpenglES学习4-立方体/">OpenglES学习4-立方体</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>这次我们参考<a href="http://www.jianshu.com/p/1c5eb6b7d809" target="_blank" rel="external">xxx</a> 实现的简单版本旋转立方体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">- (void)prepare&#123;</div><div class="line">    // 1. 基本配置</div><div class="line">    EAGLContext *ctx =  [[EAGLContext alloc] initWithAPI:kEAGLRenderingAPIOpenGLES2];</div><div class="line">    [EAGLContext setCurrentContext:ctx];</div><div class="line">    self.ctx = ctx;</div><div class="line">    </div><div class="line">    glDeleteFramebuffers(1, &amp;fboId);</div><div class="line">    glDeleteBuffers(1, &amp;colorRboId);</div><div class="line">    glDeleteBuffers(1, &amp;depthRboId);</div><div class="line">    fboId = colorRboId = depthRboId = 0;</div><div class="line">    </div><div class="line">    glGenFramebuffers(1, &amp;fboId);</div><div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, fboId);</div><div class="line">    </div><div class="line">    glGenRenderbuffers(1, &amp;colorRboId);</div><div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, colorRboId);</div><div class="line">    [self.ctx renderbufferStorage:GL_RENDERBUFFER fromDrawable:(CAEAGLLayer *)self.layer];</div><div class="line">    GLint w,h;</div><div class="line">    glGetRenderbufferParameteriv(GL_RENDERBUFFER, GL_RENDERBUFFER_WIDTH, &amp;w);</div><div class="line">    glGetRenderbufferParameteriv(GL_RENDERBUFFER, GL_RENDERBUFFER_HEIGHT, &amp;h);</div><div class="line">    self.renderSize = CGSizeMake(w, h);</div><div class="line">    glFramebufferRenderbuffer(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_RENDERBUFFER, colorRboId);</div><div class="line">    [self chkFBOStatus];</div><div class="line">    </div><div class="line">    // --- depth render buffer</div><div class="line">    glGenRenderbuffers(1, &amp;depthRboId);</div><div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, depthRboId);</div><div class="line">    //    Once a renderbuffer object is bound, we can specify the dimensions and format of the image stored in the renderbuffer.</div><div class="line">    glRenderbufferStorage(GL_RENDERBUFFER, GL_DEPTH_COMPONENT16, self.renderSize.width, self.renderSize.height);</div><div class="line">    glFramebufferRenderbuffer(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_RENDERBUFFER, depthRboId);</div><div class="line">    [self chkFBOStatus];</div><div class="line"></div><div class="line">    // 2.</div><div class="line">    glClearColor(0.423, 0.43, 0.87, 1);</div><div class="line">    </div><div class="line">    // 3. 设置顶点数据，下标数据</div><div class="line">    glGenBuffers(1, &amp;vboId);</div><div class="line">    glBindBuffer(GL_ARRAY_BUFFER, vboId);</div><div class="line">    //The vertex array data or element array data storage is created and initialized using the glBufferData command.</div><div class="line">    glBufferData(GL_ARRAY_BUFFER, sizeof(vertices), vertices, GL_STATIC_DRAW);</div><div class="line">    glBufferData(GL_ELEMENT_ARRAY_BUFFER, sizeof(indices), indices, GL_STATIC_DRAW);</div><div class="line">    </div><div class="line">    // 3. shader配置</div><div class="line">    [self setShader];</div><div class="line">    </div><div class="line">    projUnif = glGetUniformLocation(programId, &quot;u_Projection&quot;);</div><div class="line">    modelUnif = glGetUniformLocation(programId, &quot;u_ModelView&quot;);</div><div class="line">    </div><div class="line">    // 5. 给shader 参数设置数据</div><div class="line">    glEnableVertexAttribArray(0);</div><div class="line">    glVertexAttribPointer(0, 3, GL_FLOAT, GL_FALSE, sizeof(VFVertex), (const GLvoid *)offsetof(VFVertex, position));</div><div class="line">    glEnableVertexAttribArray(1);</div><div class="line">    glVertexAttribPointer(1, 4, GL_FLOAT, GL_FALSE, sizeof(VFVertex), (const GLvoid *)offsetof(VFVertex, color));</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)drawAndRender&#123;</div><div class="line">    // 1. use program</div><div class="line">    glUseProgram(programId);</div><div class="line">    // 2. transform</div><div class="line">    //FIXME: 这个不懂参数什么意思，如何取到的？</div><div class="line">    self.modelPostion = GLKVector3Make(0, -0.5, -5);</div><div class="line">    [self tansform];</div><div class="line">    </div><div class="line">    glViewport(0, 0, self.renderSize.width, self.renderSize.height);</div><div class="line">    </div><div class="line">    //FIXME: 这个不懂为什么设置？</div><div class="line">    glDepthRangef(0, 1);</div><div class="line">    // 3. clear old cached</div><div class="line">    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</div><div class="line"></div><div class="line">    // 4. open depth test</div><div class="line">    glEnable(GL_DEPTH_TEST);</div><div class="line">    glEnable(GL_CULL_FACE);</div><div class="line">    // 5. draw</div><div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, colorRboId);</div><div class="line">    //The glBindBuffer command is used to make a buffer object the current array buffer object or the current element array buffer object.</div><div class="line">//    glBindBuffer(GL_ARRAY_BUFFER, vboId);</div><div class="line">    glDrawElements(GL_TRIANGLES, sizeof(indices)/sizeof(indices[0]), GL_UNSIGNED_BYTE, indices);</div><div class="line">    </div><div class="line">    // 6. render</div><div class="line">    [self.ctx presentRenderbuffer:GL_RENDERBUFFER];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>** 遗留的几个问题</p>
<ol>
<li><p>坐标空间的转换？</p>
</li>
<li><p>shader代码为何这么写？</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenglES/">OpenglES</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-OpenglES学习3-FBO-RBO" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/12/OpenglES学习3-FBO-RBO/" class="article-date">
      <time datetime="2017-10-12T13:11:35.000Z" itemprop="datePublished">2017-10-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/12/OpenglES学习3-FBO-RBO/">OpenglES学习3 FBO RBO</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="1-FrameBuffer"><a href="#1-FrameBuffer" class="headerlink" title="1.FrameBuffer"></a>1.FrameBuffer</h1><h2 id="1-1-为什么需要FBO"><a href="#1-1-为什么需要FBO" class="headerlink" title="1.1 为什么需要FBO"></a>1.1 为什么需要FBO</h2><p>系统提供的framebuffer不适用于所有场合。比如:<br>many applications need to render to a texture, and for this using the window system provided framebuffer as your drawing surface is usually not an ideal option. Examples of where render to texture is useful are dynamic reflections and environment-mapping, multipass techniques for depth-of-field, motion blur effects, and post-processing effects.</p>
<h2 id="1-2-什么是FBO"><a href="#1-2-什么是FBO" class="headerlink" title="1.2 什么是FBO"></a>1.2 什么是FBO</h2><p>A framebuffer object (often referred to as an FBO) is a collection of color, depth, and stencil buffer attachment points; state that describes properties such as the size and format of the color, depth, and stencil buffers attached to the FBO; and the names of the texture and renderbuffer objects attached to the FBO. Various 2D images can be attached to the color attachment point in the framebuffer object. These include a renderbuffer object that stores color values, a mip-level of a 2D texture or a cubemap face, or even a mip-level of a 2D slice in a 3D texture. Similarly, various 2D images containing depth values can be attached to the depth attachment point of an FBO. These can include a renderbuffer, a mip-level of a 2D texture or a cubemap face that stores depth values. The only 2D image that can be attached to the stencil attachment point of an FBO is a renderbuffer object that stores stencil values.</p>
<ul>
<li>FBO API 支持系列操作</li>
</ul>
<p>• Creating and using multiple framebuffer objects within a single EGL context; that is, without requiring a rendering context per framebuffer.<br>• Creating off-screen color, depth, or stencil renderbuffers and textures, and attaching these to a framebuffer object.<br>• Sharing color, depth or stencil buffers across multiple framebuffers.<br>• Attaching textures directly to a framebuffer as color or depth and avoiding the need to do a copy operation.</p>
<h2 id="1-3-如何使用FBO"><a href="#1-3-如何使用FBO" class="headerlink" title="1.3 如何使用FBO"></a>1.3 如何使用FBO</h2><ol>
<li>创建</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">glGenFramebuffers</span><span class="params">(GLsizei n, GLuint *ids)</span></span></div><div class="line">n:number of framebuffer object names to return</div><div class="line">ids:pointer to an <span class="built_in">array</span> of n entries, where allocated framebuffer objects are returned</div></pre></td></tr></table></figure>
<p>ids是大于0的，等于0表示失败。</p>
<ol>
<li>glBindFramebuffer</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void glBindFramebuffer(GLenum target, GLuint framebuffer)</div><div class="line">target:must be set to GL_FRAMEBUFFER</div><div class="line">framebuffer:framebuffer object name</div></pre></td></tr></table></figure>
<p>在使用framebuffer之前,需要把framebuffer 设置为当前 fbo.<br>The first time a framebuffer object name is bound by calling glBindFrame-buffer, the framebuffer object is allocated with appropriate default state, and if the allocation is successful, this allocated object is bound as the current framebuffer object for the rendering context.</p>
<ol>
<li>glDeleteFramebuffers</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void glDeleteFramebuffers(GLsizei n, GLuint *framebuffers)</div><div class="line">n:number of framebuffer object names to delete</div><div class="line">framebuffers:pointer to an array of n framebuffer object names to be deleted</div></pre></td></tr></table></figure>
<p>Once a framebuffer object is deleted, it has no state associated with it and is marked as unused and can later be reused as a new framebuffer object. When deleting a framebuffer object that is also the currently bound framebuffer object, the framebuffer object is deleted and the current frame-buffer binding is reset to zero. If framebuffer object names specified in framebuffers are invalid or zero, they are ignored and no error will be generated.</p>
<h1 id="2-RenderBuffer"><a href="#2-RenderBuffer" class="headerlink" title="2.RenderBuffer"></a>2.RenderBuffer</h1><h2 id="1-1-为什么需要RBO"><a href="#1-1-为什么需要RBO" class="headerlink" title="1.1 为什么需要RBO"></a>1.1 为什么需要RBO</h2><h2 id="1-2-什么是RBO"><a href="#1-2-什么是RBO" class="headerlink" title="1.2 什么是RBO"></a>1.2 什么是RBO</h2><p>A renderbuffer object is a 2D image buffer allocated by the application. The renderbuffer can be used to allocate and store color, depth, or stencil values and can be used as a color, depth, or stencil attachment in a framebuffer object. A renderbuffer is similar to an off-screen window system provided drawable surface, such as a pbuffer. A renderbuffer, however, cannot be directly used as a GL texture.</p>
<h2 id="1-3-如何使用RBO"><a href="#1-3-如何使用RBO" class="headerlink" title="1.3 如何使用RBO"></a>1.3 如何使用RBO</h2>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenglES/">OpenglES</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-Opengles学习2-Vextex-attributes-Vextex-array-VBO" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/11/Opengles学习2-Vextex-attributes-Vextex-array-VBO/" class="article-date">
      <time datetime="2017-10-11T11:20:10.000Z" itemprop="datePublished">2017-10-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/11/Opengles学习2-Vextex-attributes-Vextex-array-VBO/">Opengles学习2-Vextex attributes,Vextex array,VBO</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="1-Vextex-attributes"><a href="#1-Vextex-attributes" class="headerlink" title="1. Vextex attributes"></a>1. Vextex attributes</h2><p>一个顶点基本上有postion,color，normal,texture coordinate等数据。<br> vextex attribute 分两种: 一种是所有顶点的数据都一样，比如color都是白色;相应的另一种就是有不一样的值,所有需要用array保存每个顶点的数据。</p>
<h3 id="1-1-const-vextex-attribute"><a href="#1-1-const-vextex-attribute" class="headerlink" title="1.1  const vextex attribute"></a>1.1  const vextex attribute</h3><p>设置const attribute<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void glVertexAttrib1f(GLuint index, GLfloat x); void glVertexAttrib2f(GLuint index, GLfloat x, GLfloat y); void glVertexAttrib3f(GLuint index, GLfloat x, GLfloat y, GLfloat z);</div><div class="line"></div><div class="line">stride : 代表指针位置幅度，the components of vertex attribute specified by size are stored sequentially for each vertex. stride specifies the delta between data for vertex index I and vertex (I + 1). If stride is 0, attribute data for all vertices are stored sequentially. If stride is &gt; 0, then we use the stride value as the pitch to get vertex data for next index</div></pre></td></tr></table></figure></p>
<h3 id="1-2-vertex-arrays"><a href="#1-2-vertex-arrays" class="headerlink" title="1.2 vertex  arrays"></a>1.2 vertex  arrays</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">glVertexAttribPointer(GLuint index, GLint size, GLenum type, GLboolean normalized, GLsizei stride, const void *ptr)</div></pre></td></tr></table></figure>
<p>保存顶点数据数组的两种方式：</p>
<ul>
<li>每个顶点的所有属性保存在一个struct中，然后有一个保存每个顶点struct的数组。array of structs</li>
<li>每个顶点同样属性保存在一个数组中，然后一个struct里面保存全部属性的数组。struct of arrays</li>
</ul>
<p>假如每个顶点的属性只有postion ,normal ,两个textcoord。<br>两种方式代码书写的区别：</p>
<ul>
<li>array of structs</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 每个属性的大小(几个float 组成)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_POS_SIZE      3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_NORMAL_SIZE  3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD0_SIZE  2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD1_SIZE  2</span></div><div class="line"><span class="comment">// 属性的下标</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_POS_INDX  0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_NORMAL_INDX 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD0_INDX 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD1_INDX 3</span></div><div class="line"></div><div class="line"><span class="comment">// the following 4 defines are used to determine location of various // attributes if vertex data is are stored as an array of structures</span></div><div class="line"> <span class="meta">#<span class="meta-keyword">define</span> VERTEX_POS_OFFSET 0</span></div><div class="line"> <span class="meta">#<span class="meta-keyword">define</span> VERTEX_NORMAL_OFFSET 3</span></div><div class="line"> <span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD0_OFFSET 6</span></div><div class="line"> <span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD1_OFFSET 8</span></div><div class="line"></div><div class="line"><span class="comment">// 一个顶点strcut 的大小</span></div><div class="line"> <span class="meta">#<span class="meta-keyword">define</span> VERTEX_ATTRIB_SIZE VERTEX_POS_SIZE + \</span></div><div class="line">                            VERTEX_NORMAL_SIZE + \</div><div class="line">                            VERTEX_TEXCOORD0_SIZE + \</div><div class="line">                            VERTEX_TEXCOORD1_SIZE</div><div class="line"><span class="comment">// array of structs,创建</span></div><div class="line"><span class="keyword">float</span> *p = <span class="built_in">malloc</span>(numVertices * VERTEX_ATTRIB_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</div><div class="line"><span class="comment">// 设置每个属性</span></div><div class="line"><span class="comment">// position is vertex attribute 0</span></div><div class="line">glVertexAttribPointer(VERTEX_POS_INDX, VERTEX_POS_SIZE,GL_FLOAT, GL_FALSE, VERTEX_ATTRIB_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), p);</div><div class="line"></div><div class="line"><span class="comment">// normal is vertex attribute 1</span></div><div class="line">glVertexAttribPointer(VERTEX_NORMAL_INDX, VERTEX_NORMAL_SIZE, GL_FLOAT, GL_FALSE, VERTEX_ATTRIB_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), (p + VERTEX_NORMAL_OFFSET));</div><div class="line"></div><div class="line"><span class="comment">// texture coordinate 0 is vertex attribute 2</span></div><div class="line">glVertexAttribPointer(VERTEX_TEXCOORD0_INDX, VERTEX_TEXCOORD0_SIZE, GL_FLOAT, GL_FALSE, VERTEX_ATTRIB_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), (p + VERTEX_TEXCOORD0_OFFSET));</div><div class="line"></div><div class="line"><span class="comment">// texture coordinate 1 is vertex attribute 3</span></div><div class="line">glVertexAttribPointer(VERTEX_TEXCOORD1_INDX, VERTEX_TEXCOORD1_SIZE, GL_FLOAT, GL_FALSE, VERTEX_ATTRIB_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), (p + VERTEX_TEXCOORD1_OFFSET));</div></pre></td></tr></table></figure>
<ul>
<li>struct of arrays</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 一个包含全部顶点position属性的数组</span></div><div class="line"><span class="keyword">float</span> *position = <span class="built_in">malloc</span>(numVertices * VERTEX_POS_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</div><div class="line"><span class="comment">// 一个包含全部顶点normal属性的数组</span></div><div class="line"><span class="keyword">float</span> *normal = <span class="built_in">malloc</span>(numVertices * VERTEX_NORMAL_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</div><div class="line"><span class="comment">// 一个包含全部顶点texcoord0属性的数组</span></div><div class="line"><span class="keyword">float</span> *texcoord0 = <span class="built_in">malloc</span>(numVertices * VERTEX_TEXCOORD0_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</div><div class="line"><span class="comment">// 一个包含全部顶点texcoord1属性的数组</span></div><div class="line"><span class="keyword">float</span> *texcoord1 = <span class="built_in">malloc</span>(numVertices * VERTEX_TEXCOORD1_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</div><div class="line"></div><div class="line"><span class="comment">// position is vertex attribute 0</span></div><div class="line"> glVertexAttribPointer(VERTEX_POS_INDX, VERTEX_POS_SIZE,GL_FLOAT, GL_FALSE, VERTEX_POS_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), position);</div><div class="line"></div><div class="line"><span class="comment">// normal is vertex attribute 1</span></div><div class="line">glVertexAttribPointer(VERTEX_NORMAL_INDX, VERTEX_NORMAL_SIZE,GL_FLOAT, GL_FALSE, VERTEX_NORMAL_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), normal);</div><div class="line"></div><div class="line"><span class="comment">// texture coordinate 0 is vertex attribute 2</span></div><div class="line">glVertexAttribPointer(VERTEX_TEXCOORD0_INDX, VERTEX_TEXCOORD0_SIZE, GL_FLOAT, GL_FALSE, VERTEX_TEXCOORD0_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), texcoord0);</div><div class="line"></div><div class="line"><span class="comment">// texture coordinate 1 is vertex attribute 3</span></div><div class="line">glVertexAttribPointer(VERTEX_TEXCOORD1_INDX, VERTEX_TEXCOORD1_SIZE, GL_FLOAT, GL_FALSE, VERTEX_TEXCOORD1_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">float</span>), texcoord1);</div></pre></td></tr></table></figure>
<h3 id="1-3-选择使用const-vextex-还是vextex-array"><a href="#1-3-选择使用const-vextex-还是vextex-array" class="headerlink" title="1.3 选择使用const vextex 还是vextex array"></a>1.3 选择使用const vextex 还是vextex array</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">void glEnableVertexAttribArray(GLuint index);</div><div class="line">void glDisableVertexAttribArray(GLuint index);</div></pre></td></tr></table></figure>
<h2 id="2-VBO"><a href="#2-VBO" class="headerlink" title="2. VBO"></a>2. VBO</h2><p>为什么需要vbo,因为vextex data，vextex arrays 保存在应用内存中，当绘制的时候需要拷贝到GPU内存中，影响性能。<br>所以如果能把vextex data 直接放大GPU内存中就好了。</p>
<h3 id="2-1-那什么是VBO"><a href="#2-1-那什么是VBO" class="headerlink" title="2.1 那什么是VBO?"></a>2.1 那什么是VBO?</h3><p>Opengles 中有两种类型的buffer object：</p>
<ul>
<li>array buffer object</li>
</ul>
<p><code>GL_ARRAY_BUFFER</code> 用来保存vextex data.</p>
<ul>
<li>element buffer object</li>
</ul>
<p><code>GL_ELEMENT_ARRAY_BUFFER</code>用来保存 图元的indicts.</p>
<h3 id="2-2-如何使用VBO"><a href="#2-2-如何使用VBO" class="headerlink" title="2.2 如何使用VBO?"></a>2.2 如何使用VBO?</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建</span></div><div class="line">glGenBuffers(<span class="number">2</span>, vboIds);</div><div class="line"><span class="comment">//  设置为当前的 array buffer</span></div><div class="line">glBindBuffer(GL_ARRAY_BUFFER, vboIds[<span class="number">0</span>]);</div><div class="line">glBufferData(GL_ARRAY_BUFFER, numVertices * <span class="keyword">sizeof</span>(<span class="keyword">vertex_t</span>), vertexBuffer, GL_STATIC_DRAW);</div><div class="line"><span class="comment">// bind buffer object for element indices</span></div><div class="line">glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, vboIds[<span class="number">1</span>]);</div><div class="line">glBufferData(GL_ELEMENT_ARRAY_BUFFER,numIndices * <span class="keyword">sizeof</span>(GLushort),indices, GL_STATIC_DRAW);</div></pre></td></tr></table></figure>
<p>看一下代码 绘制图元 不用VBO和使用VBOde 区别</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 每个属性的大小(几个float 组成)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_POS_SIZE      3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_NORMAL_SIZE  3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD0_SIZE  2</span></div><div class="line"><span class="comment">// 属性的下标</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_POS_INDX  0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_NORMAL_INDX 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VERTEX_TEXCOORD0_INDX 2</span></div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">void</span> <span class="title">drawPrimitiveWithoutVBOs</span><span class="params">(GLfloat *vertices, GLint vtxStride, GLint numIndices, GLushort *indices)</span> </span>&#123;</div><div class="line">   GLfloat *vtxBuf = vertices;</div><div class="line">   glBindBuffer(GL_ARRAY_BUFFER, <span class="number">0</span>);</div><div class="line">   glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, <span class="number">0</span>);</div><div class="line"></div><div class="line">   glEnableVertexAttribArray(VERTEX_POS_INDX);</div><div class="line">   glEnableVertexAttribArray(VERTEX_NORMAL_INDX);</div><div class="line">   glEnableVertexAttribArray&#123;VERTEX_TEXCOORD0_INDX);</div><div class="line"></div><div class="line">   glVertexAttribPointer(VERTEX_POS_INDX, VERTEX_POS_SIZE, GL_FLOAT, GL_FALSE, vtxStride, vtxBuf);</div><div class="line">   vtxBuf += VERTEX_POS_SIZE;</div><div class="line">   glVertexAttribPointer(VERTEX_NORMAL_INDX, VERTEX_NORMAL_SIZE, GL_FLOAT, GL_FALSE, vtxStride, vtxBuf);</div><div class="line">   vtxBuf += VERTEX_NORMAL_SIZE;</div><div class="line">   glVertexAttribPointer(VERTEX_TEXCOORD0_INDX,VERTEX_TEXCOORD0_SIZE, GL_FLOAT, GL_FALSE, vtxStride, vtxBuf);</div><div class="line"></div><div class="line">   glBindAttribLocation(program, VERTEX_POS_INDX, <span class="string">"v_position"</span>);</div><div class="line">   glBindAttribLocation(program, VERTEX_NORMAL_INDX, <span class="string">"v_normal"</span>);</div><div class="line">   glBindAttribLocation(program, VERTEX_TEXCOORD0_INDX, <span class="string">"v_texcoord"</span>);</div><div class="line"></div><div class="line">   glDrawElements(GL_TRIANGLES, numIndices, GL_UNSIGNED_SHORT, indices);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">void</span> <span class="title">drawPrimitiveWithVBOs</span><span class="params">(GLint numVertices, GLfloat *vtxBuf, GLint vtxStride, GLint numIndices, GLushort *indices)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   GLuint offset = <span class="number">0</span>;</div><div class="line">   GLuint vboIds[<span class="number">2</span>];<span class="comment">// vboIds[0] – used to store vertex attribute data // vboIds[1] – used to store element indices glGenBuffers(2, vboIds);</span></div><div class="line"></div><div class="line">   glBindBuffer(GL_ARRAY_BUFFER, vboIds[<span class="number">0</span>]);</div><div class="line">   glBufferData(GL_ARRAY_BUFFER, vtxStride * numVertices, vtxBuf, GL_STATIC_DRAW);</div><div class="line">   glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, vboIds[<span class="number">1</span>]);</div><div class="line"></div><div class="line">   glBufferData(GL_ELEMENT_ARRAY_BUFFER, <span class="keyword">sizeof</span>(GLushort) * numIndices, indices, GL_STATIC_DRAW);</div><div class="line"></div><div class="line">   glEnableVertexAttribArray(VERTEX_POS_INDX);</div><div class="line">   glEnableVertexAttribArray(VERTEX_NORMAL_INDX);</div><div class="line">   glEnableVertexAttribArray&#123;VERTEX_TEXCOORD0_INDX);</div><div class="line"></div><div class="line">     glVertexAttribPointer(VERTEX_POS_INDX, VERTEX_POS_SIZE, GL_FLOAT, GL_FALSE, vtxStride, (<span class="keyword">const</span> <span class="keyword">void</span>*)offset);</div><div class="line"></div><div class="line">     offset += VERTEX_POS_SIZE * <span class="keyword">sizeof</span>(GLfloat);</div><div class="line">     glVertexAttribPointer(VERTEX_NORMAL_INDX, VERTEX_NORMAL_SIZE, GL_FLOAT, GL_FALSE, vtxStride, (<span class="keyword">const</span> <span class="keyword">void</span>*)offset);</div><div class="line"></div><div class="line">     offset += VERTEX_NORMAL_SIZE * <span class="keyword">sizeof</span>(GLfloat);</div><div class="line">     glVertexAttribPointer(VERTEX_TEXCOORD0_INDX,VERTEX_TEXCOORD0_SIZE, GL_FLOAT, GL_FALSE, vtxStride, (<span class="keyword">const</span> <span class="keyword">void</span>*)offset);</div><div class="line"></div><div class="line"></div><div class="line">     glBindAttribLocation(program, VERTEX_POS_INDX, <span class="string">"v_position"</span>);</div><div class="line">     glBindAttribLocation(program, VERTEX_NORMAL_INDX, <span class="string">"v_normal"</span>);</div><div class="line">     glBindAttribLocation(program, VERTEX_TEXCOORD0_INDX, <span class="string">"v_texcoord"</span>);</div><div class="line"></div><div class="line">     glDrawElements(GL_TRIANGLES, numIndices, GL_UNSIGNED_SHORT, <span class="number">0</span>);</div><div class="line"></div><div class="line">     glDeleteBuffers(<span class="number">2</span>, vboIds);</div><div class="line"></div><div class="line"> &#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenglES/">OpenglES</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-Opengl学习1-draw-line-on-ios" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/11/Opengl学习1-draw-line-on-ios/" class="article-date">
      <time datetime="2017-10-11T10:46:29.000Z" itemprop="datePublished">2017-10-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/11/Opengl学习1-draw-line-on-ios/">Opengl学习1- draw line on ios</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">//  ZYGLView.m</div><div class="line">//  esgl_1</div><div class="line">//</div><div class="line">//  Created by zhangyun on 2017/10/9.</div><div class="line">//  Copyright © 2017年 zhangyun. All rights reserved.</div><div class="line">//</div><div class="line"></div><div class="line">#import &quot;ZYGLView.h&quot;</div><div class="line">#import &lt;GLKit/GLKit.h&gt;</div><div class="line">#import &quot;VFMatrix.h&quot;</div><div class="line"></div><div class="line">typedef struct&#123;</div><div class="line">    CGFloat red;</div><div class="line">    CGFloat green;</div><div class="line">    CGFloat blue;</div><div class="line">    CGFloat alpha;</div><div class="line">&#125;RGBAColor;</div><div class="line"></div><div class="line">// vertex attribute struct</div><div class="line">typedef struct &#123;</div><div class="line">    GLfloat Position[3];</div><div class="line">    GLfloat Color[4];</div><div class="line"></div><div class="line">&#125;VFVertex;</div><div class="line"></div><div class="line">// 白色</div><div class="line">static const GLfloat whiteColor[] = &#123;1,1,1,1&#125;;</div><div class="line">static const RGBAColor kDefaultColor = &#123;0.4,0.7,0.9,1.f&#125;;</div><div class="line"></div><div class="line">// 4个顶点的数据</div><div class="line">static const VFVertex crossLinesVertices[] = &#123;</div><div class="line">  // line one</div><div class="line">    &#123;0.5f,0.5f,0.f&#125;,</div><div class="line">    &#123;-0.5f,-0.5f,0.f&#125;,</div><div class="line"></div><div class="line">    // line two</div><div class="line">    &#123;-0.53f,0.48f,0.f&#125;,</div><div class="line">    &#123;0.55f,-0.4f,0.f&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">@interface ZYGLView()&#123;</div><div class="line">    GLint programID;</div><div class="line">&#125;</div><div class="line">@property (nonatomic,strong) EAGLContext *ctx;</div><div class="line">@property (nonatomic,assign) GLfloat windowScale;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ZYGLView</div><div class="line"></div><div class="line">+ (Class)layerClass&#123;</div><div class="line">    return [CAEAGLLayer class];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithFrame:(CGRect)frame&#123;</div><div class="line">    if (self = [super initWithFrame:frame]) &#123;</div><div class="line">        CAEAGLLayer *layer = (CAEAGLLayer *)self.layer;</div><div class="line">        layer.drawableProperties = @&#123;kEAGLDrawablePropertyColorFormat: kEAGLColorFormatRGBA8,kEAGLDrawablePropertyRetainedBacking:@(YES)&#125;;</div><div class="line">        layer.contentsScale = [UIScreen mainScreen].scale;</div><div class="line">        layer.opaque = YES;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)prepare&#123;</div><div class="line"></div><div class="line">    // 1.设置上下文环境</div><div class="line">    EAGLContext *ctx = [[EAGLContext alloc] initWithAPI:kEAGLRenderingAPIOpenGLES2];</div><div class="line">    [EAGLContext setCurrentContext:ctx];</div><div class="line">    self.ctx = ctx;</div><div class="line"></div><div class="line">    // 2. 设置背景颜色</div><div class="line">    glClearColor(kDefaultColor.red, kDefaultColor.green, kDefaultColor.blue, kDefaultColor.alpha);</div><div class="line"></div><div class="line">    // 3. 配置rbo</div><div class="line">    GLuint rboId;</div><div class="line">    glGenRenderbuffers(1, &amp;rboId);</div><div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, rboId);</div><div class="line"></div><div class="line">    // 4. 配置fbo</div><div class="line">    GLuint fboId;</div><div class="line">    glGenFramebuffers(1, &amp;fboId);</div><div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, fboId);</div><div class="line"></div><div class="line">    // 5. 绑定fbo rbo</div><div class="line">   glFramebufferRenderbuffer(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_RENDERBUFFER, rboId);</div><div class="line"></div><div class="line">    // 6. 绑定renderbuffer到绘制表面</div><div class="line">    [ctx renderbufferStorage:GL_RENDERBUFFER fromDrawable:(CAEAGLLayer *)self.layer];</div><div class="line"></div><div class="line">    // 7. 下面的shader的内容</div><div class="line">    GLuint vertexId = [self addShader:GL_VERTEX_SHADER];</div><div class="line">    GLuint fragmentId = [self addShader:GL_FRAGMENT_SHADER];</div><div class="line">    if (vertexId ==0 || fragmentId == 0) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 8. 创建program</div><div class="line">    GLuint programId = glCreateProgram();</div><div class="line"></div><div class="line">    // 9. 添加shader 到program</div><div class="line">    glAttachShader(programId, vertexId);</div><div class="line">    glAttachShader(programId, fragmentId);</div><div class="line"></div><div class="line">    // 10. 设置attribute 的index</div><div class="line">    glBindAttribLocation(programId, 0, &quot;v_Position&quot;);</div><div class="line">    glBindAttribLocation(programId, 1, &quot;v_Color&quot;);</div><div class="line"></div><div class="line">    // 11. link program</div><div class="line">    glLinkProgram(programId);</div><div class="line">    GLint linkSuccess;</div><div class="line">    // 检查是否链接成功</div><div class="line">    glGetProgramiv(programId, GL_LINK_STATUS, &amp;linkSuccess);</div><div class="line">    if (linkSuccess == GL_FALSE) &#123;</div><div class="line">        GLint infoLen;</div><div class="line">        glGetProgramiv(programId, GL_INFO_LOG_LENGTH, &amp;infoLen);</div><div class="line">        if (infoLen &gt; 0) &#123;</div><div class="line">            GLchar *msg = malloc(sizeof(GLchar *) * infoLen);</div><div class="line">            glGetProgramInfoLog(programId, infoLen,NULL, msg);</div><div class="line">            NSString *str = [NSString stringWithUTF8String:msg];</div><div class="line">            NSLog(@&quot;**----&gt;shader link error:%@&quot;,str);</div><div class="line">            free(msg);</div><div class="line">        &#125;</div><div class="line">        NSLog(@&quot;**----&gt;shader link error return&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    programID = programId;</div><div class="line"></div><div class="line">    // 12. 重置渲染内存</div><div class="line">    glClear(GL_COLOR_BUFFER_BIT);</div><div class="line"></div><div class="line">    // 13. 设置视窗</div><div class="line">    GLint renderbufW,renderbufH;</div><div class="line">    // 获取当前设备窗口的宽高</div><div class="line">    glGetRenderbufferParameteriv(GL_RENDERBUFFER, GL_RENDERBUFFER_WIDTH, &amp;renderbufW);</div><div class="line">    glGetRenderbufferParameteriv(GL_RENDERBUFFER, GL_RENDERBUFFER_HEIGHT, &amp;renderbufH);</div><div class="line">    glViewport(0, 0, renderbufW, renderbufH);</div><div class="line"></div><div class="line">    // 获取宽高比,用来做坐标系转换</div><div class="line">    self.windowScale = ((GLfloat)renderbufW / (GLfloat)renderbufH);</div><div class="line"></div><div class="line">    // 14. 加载顶点数据</div><div class="line">    GLuint vboId;</div><div class="line">    glGenBuffers(1, &amp;vboId);</div><div class="line"></div><div class="line">    const GLvoid *dataPtr;</div><div class="line">    GLsizeiptr dataSize;</div><div class="line">    GLsizei verticesIndicesCount;</div><div class="line"></div><div class="line">    dataSize = sizeof(crossLinesVertices);</div><div class="line">    dataPtr = crossLinesVertices;</div><div class="line">    verticesIndicesCount = (GLsizei)(sizeof(crossLinesVertices) / sizeof(crossLinesVertices[0]));</div><div class="line"></div><div class="line">    // vbo</div><div class="line">    glBindBuffer(GL_ARRAY_BUFFER, vboId);</div><div class="line">    glBufferData(GL_ARRAY_BUFFER, dataSize, dataPtr, GL_STATIC_DRAW);</div><div class="line">    glEnableVertexAttribArray(0);</div><div class="line">    // 设置shader中postion数据</div><div class="line">    glVertexAttribPointer(0, 3, GL_FLOAT, GL_FALSE, sizeof(VFVertex), (const GLvoid *)offsetof(VFVertex,Position));</div><div class="line">    // 设置shader 中color数据</div><div class="line">    glDisableVertexAttribArray(1);</div><div class="line">    glVertexAttrib4fv(1, whiteColor);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)display&#123;</div><div class="line">    // 1. 使用program</div><div class="line">    glUseProgram(programID);</div><div class="line"></div><div class="line">    // 2. 坐标系转换，这块好复杂，没搞懂，直接使用了https://github.com/huangwenfei/OpenGLES2Learning 里的代码</div><div class="line">    VFMatrix4 scaleMat4 = VFMatrix4MakeScaleY(self.windowScale);</div><div class="line">    VFMatrix4 transMat4 = VFMatrix4Identity;</div><div class="line">    glUniformMatrix4fv(0,   // 定义的 uniform 变量的内存标识符</div><div class="line">                       1,                                           // 不是 uniform 数组，只是一个 uniform -&gt; 1</div><div class="line">                       GL_FALSE,                                    // ES 下 只能是 False</div><div class="line">                       (const GLfloat *)scaleMat4.m1D);             // 数据的首指针</div><div class="line"></div><div class="line">    glUniformMatrix4fv(1,   // 定义的 uniform 变量的内存标识符</div><div class="line">                       1,                                           // 不是 uniform 数组，只是一个 uniform -&gt; 1</div><div class="line">                       GL_FALSE,                                    // ES 下 只能是 False</div><div class="line">                       (const GLfloat *)transMat4.m1D);             // 数据的首指针</div><div class="line"></div><div class="line">    glLineWidth(10);</div><div class="line">    // 2. 绘制</div><div class="line">    glDrawArrays(GL_LINES, 0, 4);</div><div class="line"></div><div class="line">    // 3. 展示renderbuffer内容</div><div class="line">    [self.ctx presentRenderbuffer:GL_RENDERBUFFER];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (GLuint)addShader:(GLenum)type&#123;</div><div class="line">    NSString *fileName;</div><div class="line">    if (type == GL_VERTEX_SHADER) &#123;</div><div class="line">        fileName = @&quot;vertex.glsl&quot;;</div><div class="line">    &#125;else&#123;</div><div class="line">        fileName = @&quot;fragment.glsl&quot;;</div><div class="line">    &#125;</div><div class="line">    // 1. 从文件中加载shader代码</div><div class="line">    NSString *path = [[NSBundle mainBundle] pathForResource:fileName ofType:nil];</div><div class="line">    NSString *shaderSource = [NSString stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:nil];</div><div class="line"></div><div class="line">    const GLchar *stringDatas = [shaderSource UTF8String];</div><div class="line">    GLint stringLen = (GLint)shaderSource.length;</div><div class="line"></div><div class="line">    // 2. 创建shader</div><div class="line">    GLuint shaderId = glCreateShader(type);</div><div class="line"></div><div class="line">    // 3. 加载代码</div><div class="line">    glShaderSource(shaderId, 1, &amp;stringDatas, &amp;stringLen);</div><div class="line"></div><div class="line">    // 4. 编译</div><div class="line">    glCompileShader(shaderId);</div><div class="line">    GLint compileSuccess;</div><div class="line"></div><div class="line">    // 5. 检查是否编译成功</div><div class="line">    glGetShaderiv(shaderId, GL_COMPILE_STATUS, &amp;compileSuccess);</div><div class="line">    if (compileSuccess == GL_FALSE) &#123;</div><div class="line">        GLint infoLen;</div><div class="line">        glGetShaderiv(shaderId, GL_INFO_LOG_LENGTH, &amp;infoLen);</div><div class="line">        if (infoLen &gt; 0) &#123;</div><div class="line">            GLchar *msg = malloc(sizeof(GLchar *) * infoLen);</div><div class="line">            glGetShaderInfoLog(shaderId, infoLen, NULL, msg);</div><div class="line">            NSString *msgS = [NSString stringWithUTF8String:msg];</div><div class="line">            NSLog(@&quot;&amp;&amp;&amp;--&gt;shader erro: %@&quot;,msgS);</div><div class="line">            free(msg);</div><div class="line">        &#125;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    return shaderId;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenglES/">OpenglES</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-VideoToolBox-压缩" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/25/VideoToolBox-压缩/" class="article-date">
      <time datetime="2017-09-25T09:52:41.000Z" itemprop="datePublished">2017-09-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/25/VideoToolBox-压缩/">VideoToolBox 压缩</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="VTCompressionSession"><a href="#VTCompressionSession" class="headerlink" title="VTCompressionSession"></a>VTCompressionSession</h2><p>管理输入视频数据压缩的会话。<br>压缩会话支持一系列视频frame的压缩。流程如下：</p>
<ul>
<li><code>VTCompressionSessionCreate</code> 创建session</li>
<li>使用<code>VTSessionSetProperty</code> <code>VTSessionSetProperties</code> 配置sessions属性。</li>
<li>使用<code>VTCompressionSessionEncodeFrame</code>编码视频frames,在<code>VTCompressionOutputCallback</code> 里接收压缩的视频frames.</li>
<li><code>VTComressionSessionCompleteFrames</code> 表示没有视频数据输入了。</li>
<li><code>VTCompressionSessionInvalidate</code> 结束session，释放内存。</li>
</ul>
<hr>
<ul>
<li><p>创建session</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">VTCompressionSessionCreate</div></pre></td></tr></table></figure>
</li>
<li><p>配置session</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Compression Properties</div><div class="line">Properties used to configure a VideoToolbox compression session.</div></pre></td></tr></table></figure>
<ul>
<li><p>编码frame</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">VTCompressionSessionPrepareToEncodeFrames</div><div class="line">编码器在开始编码前进行资源分配，可选</div><div class="line"></div><div class="line">VTCompressionSessionEncodeFrame</div><div class="line">给session 提供frame</div><div class="line"></div><div class="line">VTCompressionSessionEncodeFrameWithOutputHandler</div><div class="line">给sesion 提供frame，压缩完成后调用callback。</div><div class="line"></div><div class="line">VTCompressionSessionCompleteFrames</div><div class="line">结束压缩session。</div></pre></td></tr></table></figure>
</li>
<li><p>检查session</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">VTCompressionSessionGetPixelBufferPool</div><div class="line">返回一个为压缩session提供理想资源pixel buffer的容器池。</div><div class="line"></div><div class="line">VTCompressionSessionGetTypeID</div><div class="line">Retrieves the Core Foundation type identifier for the compression session.</div></pre></td></tr></table></figure>
</li>
<li><p>多通道压缩</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">VTCompressionSessionBeginPass</div><div class="line">标记一个压缩通道的开始</div><div class="line"></div><div class="line">VTCompressionSessionEndPass</div><div class="line">Marks the end of a compression pass.</div><div class="line"></div><div class="line">VTCompressionSessionGetTimeRangesForNextPass</div><div class="line">获取下一个通道的时间范围。</div></pre></td></tr></table></figure>
</li>
<li><p>结束Session</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">VTCompressionSessionInvalidate</div><div class="line">Tears down a compression session.</div></pre></td></tr></table></figure>
<ul>
<li>数据类型</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">VTCompressionSessionRef</div><div class="line">A reference to a VideoToolbox compression session.</div><div class="line">VTCompressionOutputCallback</div><div class="line">Prototype for the callback invoked when frame compression is complete.</div><div class="line">VTCompressionOutputHandler</div><div class="line">Prototype for the block invoked when frame compression is complete.</div></pre></td></tr></table></figure>
<ul>
<li>枚举<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">VTCompressionSessionOptionFlags</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">VTEncodeInfoFlags</div><div class="line">kVTEncodeInfo_Asynchronous</div><div class="line">异步编码</div><div class="line">kVTEncodeInfo_FrameDropped</div><div class="line">编码的时候一个frame 被丢弃了。</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/video-FFmpeg/">video,FFmpeg</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-ffmpeg-transcoding" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/19/ffmpeg-transcoding/" class="article-date">
      <time datetime="2017-09-19T11:34:35.000Z" itemprop="datePublished">2017-09-19</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/19/ffmpeg-transcoding/">ffmpeg transcoding</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavfilter/avfiltergraph.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavfilter/avcodec.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavfilter/buffersink.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavfilter/buffersrc.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/opt.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/pixdesc.h&gt;</span></span></div><div class="line"><span class="keyword">static</span> AVFormatContext *ifmt_ctx;</div><div class="line"><span class="keyword">static</span> AVFormatContext *ofmt_ctx;</div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FilteringContext</span> &#123;</span></div><div class="line">    AVFilterContext *buffersink_ctx;</div><div class="line">    AVFilterContext *buffersrc_ctx;</div><div class="line">    AVFilterGraph *filter_graph;</div><div class="line">&#125; FilteringContext;</div><div class="line"><span class="keyword">static</span> FilteringContext *filter_ctx;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_input_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</div><div class="line">    ifmt_ctx = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> ((ret = avformat_open_input(&amp;ifmt_ctx, filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>) &#123;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot open input file\n"</span>);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((ret = avformat_find_stream_info(ifmt_ctx, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>) &#123;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot find stream information\n"</span>);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i++) &#123;</div><div class="line">        AVStream *stream;</div><div class="line">        AVCodecContext *codec_ctx;</div><div class="line">        stream = ifmt_ctx-&gt;streams[i];</div><div class="line">        codec_ctx = stream-&gt;codec;</div><div class="line">        <span class="comment">/* Reencode video &amp; audio and remux subtitles etc. */</span></div><div class="line">        <span class="keyword">if</span> (codec_ctx-&gt;codec_type == AVMEDIA_TYPE_VIDEO</div><div class="line">                || codec_ctx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) &#123;</div><div class="line">            <span class="comment">/* Open decoder */</span></div><div class="line">            ret = avcodec_open2(codec_ctx,</div><div class="line">                    avcodec_find_decoder(codec_ctx-&gt;codec_id), <span class="literal">NULL</span>);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Failed to open decoder for stream #%u\n"</span>, i);</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    av_dump_format(ifmt_ctx, <span class="number">0</span>, filename, <span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_output_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    AVStream *out_stream;</div><div class="line">    AVStream *in_stream;</div><div class="line">    AVCodecContext *dec_ctx, *enc_ctx;</div><div class="line">    AVCodec *encoder;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</div><div class="line">    ofmt_ctx = <span class="literal">NULL</span>;</div><div class="line">    <span class="comment">//Allocate an AVFormatContext for an output format.</span></div><div class="line">    avformat_alloc_output_context2(&amp;ofmt_ctx, <span class="literal">NULL</span>, <span class="literal">NULL</span>, filename);</div><div class="line">    <span class="keyword">if</span> (!ofmt_ctx) &#123;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Could not create output context\n"</span>);</div><div class="line">        <span class="keyword">return</span> AVERROR_UNKNOWN;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i++) &#123;</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">      Add a new stream to a media file.</span></div><div class="line"><span class="comment">      When demuxing, it is called by the demuxer in read_header(). If the flag AVFMTCTX_NOHEADER is set in s.ctx_flags,</span></div><div class="line"><span class="comment">      then it may also be called in read_packet().When muxing, should be called by the user before avformat_write_header().</span></div><div class="line"><span class="comment">      User is required to call avcodec_close() and avformat_free_context() to clean up the allocation by avformat_new_stream().</span></div><div class="line"><span class="comment">      */</span></div><div class="line">        out_stream = avformat_new_stream(ofmt_ctx, <span class="literal">NULL</span>);</div><div class="line">        <span class="keyword">if</span> (!out_stream) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Failed allocating output stream\n"</span>);</div><div class="line">            <span class="keyword">return</span> AVERROR_UNKNOWN;</div><div class="line">        &#125;</div><div class="line">        in_stream = ifmt_ctx-&gt;streams[i];</div><div class="line">        dec_ctx = in_stream-&gt;codec;</div><div class="line">        enc_ctx = out_stream-&gt;codec;</div><div class="line">        <span class="keyword">if</span> (dec_ctx-&gt;codec_type == AVMEDIA_TYPE_VIDEO</div><div class="line">                || dec_ctx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) &#123;</div><div class="line">            <span class="comment">/* in this example, we choose transcoding to same codec */</span></div><div class="line">            encoder = avcodec_find_encoder(dec_ctx-&gt;codec_id);</div><div class="line">            <span class="keyword">if</span> (!encoder) &#123;</div><div class="line">                av_log(<span class="literal">NULL</span>, AV_LOG_FATAL, <span class="string">"Necessary encoder not found\n"</span>);</div><div class="line">                <span class="keyword">return</span> AVERROR_INVALIDDATA;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/* In this example, we transcode to same properties (picture size,</span></div><div class="line"><span class="comment">             * sample rate etc.). These properties can be changed for output</span></div><div class="line"><span class="comment">             * streams easily using filters */</span></div><div class="line">            <span class="keyword">if</span> (dec_ctx-&gt;codec_type == AVMEDIA_TYPE_VIDEO) &#123;</div><div class="line">                enc_ctx-&gt;height = dec_ctx-&gt;height;</div><div class="line">                enc_ctx-&gt;width = dec_ctx-&gt;width;</div><div class="line">                enc_ctx-&gt;sample_aspect_ratio = dec_ctx-&gt;sample_aspect_ratio;</div><div class="line">                <span class="comment">/* take first format from list of supported formats */</span></div><div class="line">                enc_ctx-&gt;pix_fmt = encoder-&gt;pix_fmts[<span class="number">0</span>];</div><div class="line">                <span class="comment">/* video time_base can be set to whatever is handy and supported by encoder */</span></div><div class="line">                enc_ctx-&gt;time_base = dec_ctx-&gt;time_base;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                enc_ctx-&gt;sample_rate = dec_ctx-&gt;sample_rate;</div><div class="line">                enc_ctx-&gt;channel_layout = dec_ctx-&gt;channel_layout;</div><div class="line">                enc_ctx-&gt;channels = av_get_channel_layout_nb_channels(enc_ctx-&gt;channel_layout);</div><div class="line">                <span class="comment">/* take first format from list of supported formats */</span></div><div class="line">                enc_ctx-&gt;sample_fmt = encoder-&gt;sample_fmts[<span class="number">0</span>];</div><div class="line">                enc_ctx-&gt;time_base = (AVRational)&#123;<span class="number">1</span>, enc_ctx-&gt;sample_rate&#125;;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/* Third parameter can be used to pass settings to encoder */</span></div><div class="line">            ret = avcodec_open2(enc_ctx, encoder, <span class="literal">NULL</span>);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot open video encoder for stream #%u\n"</span>, i);</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dec_ctx-&gt;codec_type == AVMEDIA_TYPE_UNKNOWN) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_FATAL, <span class="string">"Elementary stream #%d is of unknown type, cannot proceed\n"</span>, i);</div><div class="line">            <span class="keyword">return</span> AVERROR_INVALIDDATA;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/* if this stream must be remuxed */</span></div><div class="line">            ret = avcodec_copy_context(ofmt_ctx-&gt;streams[i]-&gt;codec,</div><div class="line">                    ifmt_ctx-&gt;streams[i]-&gt;codec);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Copying stream context failed\n"</span>);</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)</div><div class="line">            enc_ctx-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;</div><div class="line">    &#125; <span class="comment">// for</span></div><div class="line">    av_dump_format(ofmt_ctx, <span class="number">0</span>, filename, <span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (!(ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE)) &#123;</div><div class="line">      <span class="comment">//Create and initialize a AVIOContext for accessing the resource indicated by url.</span></div><div class="line">      <span class="comment">//When the resource indicated by url has been opened in read+write mode, the AVIOContext can be used only for writing.</span></div><div class="line">        ret = avio_open(&amp;ofmt_ctx-&gt;pb, filename, AVIO_FLAG_WRITE);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Could not open output file '%s'"</span>, filename);</div><div class="line">            <span class="keyword">return</span> ret;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* init muxer, write output file header */</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    Allocate the stream private data and write the stream header to an output media file.</span></div><div class="line"><span class="comment">    s	Media file handle, must be allocated with avformat_alloc_context().</span></div><div class="line"><span class="comment">    Its oformat field must be set to the desired output format; Its pb field must be set to an already opened AVIOContext.</span></div><div class="line"><span class="comment">    options	An AVDictionary filled with AVFormatContext and muxer-private options.</span></div><div class="line"><span class="comment">    On return this parameter will be destroyed and replaced with a dict containing options that were not found. May be NULL.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    ret = avformat_write_header(ofmt_ctx, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Error occurred when opening output file\n"</span>);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init_filter</span><span class="params">(FilteringContext* fctx, AVCodecContext *dec_ctx,</span></span></div><div class="line"><span class="function"><span class="params">        AVCodecContext *enc_ctx, <span class="keyword">const</span> <span class="keyword">char</span> *filter_spec)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">char</span> args[<span class="number">512</span>];</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">    AVFilter *buffersrc = <span class="literal">NULL</span>;</div><div class="line">    AVFilter *buffersink = <span class="literal">NULL</span>;</div><div class="line">    AVFilterContext *buffersrc_ctx = <span class="literal">NULL</span>;</div><div class="line">    AVFilterContext *buffersink_ctx = <span class="literal">NULL</span>;</div><div class="line">    AVFilterInOut *outputs = avfilter_inout_alloc();</div><div class="line">    AVFilterInOut *inputs  = avfilter_inout_alloc();</div><div class="line">    AVFilterGraph *filter_graph = avfilter_graph_alloc();</div><div class="line">    <span class="keyword">if</span> (!outputs || !inputs || !filter_graph) &#123;</div><div class="line">        ret = AVERROR(ENOMEM);</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (dec_ctx-&gt;codec_type == AVMEDIA_TYPE_VIDEO) &#123;</div><div class="line">        buffersrc = avfilter_get_by_name(<span class="string">"buffer"</span>);</div><div class="line">        buffersink = avfilter_get_by_name(<span class="string">"buffersink"</span>);</div><div class="line">        <span class="keyword">if</span> (!buffersrc || !buffersink) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"filtering source or sink element not found\n"</span>);</div><div class="line">            ret = AVERROR_UNKNOWN;</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">snprintf</span>(args, <span class="keyword">sizeof</span>(args),</div><div class="line">                <span class="string">"video_size=%dx%d:pix_fmt=%d:time_base=%d/%d:pixel_aspect=%d/%d"</span>,</div><div class="line">                dec_ctx-&gt;width, dec_ctx-&gt;height, dec_ctx-&gt;pix_fmt,</div><div class="line">                dec_ctx-&gt;time_base.num, dec_ctx-&gt;time_base.den,</div><div class="line">                dec_ctx-&gt;sample_aspect_ratio.num,</div><div class="line">                dec_ctx-&gt;sample_aspect_ratio.den);</div><div class="line">        ret = avfilter_graph_create_filter(&amp;buffersrc_ctx, buffersrc, <span class="string">"in"</span>,</div><div class="line">                args, <span class="literal">NULL</span>, filter_graph);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot create buffer source\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        ret = avfilter_graph_create_filter(&amp;buffersink_ctx, buffersink, <span class="string">"out"</span>,</div><div class="line">                <span class="literal">NULL</span>, <span class="literal">NULL</span>, filter_graph);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot create buffer sink\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        ret = av_opt_set_bin(buffersink_ctx, <span class="string">"pix_fmts"</span>,</div><div class="line">                (<span class="keyword">uint8_t</span>*)&amp;enc_ctx-&gt;pix_fmt, <span class="keyword">sizeof</span>(enc_ctx-&gt;pix_fmt),</div><div class="line">                AV_OPT_SEARCH_CHILDREN);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot set output pixel format\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dec_ctx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) &#123;</div><div class="line">        buffersrc = avfilter_get_by_name(<span class="string">"abuffer"</span>);</div><div class="line">        buffersink = avfilter_get_by_name(<span class="string">"abuffersink"</span>);</div><div class="line">        <span class="keyword">if</span> (!buffersrc || !buffersink) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"filtering source or sink element not found\n"</span>);</div><div class="line">            ret = AVERROR_UNKNOWN;</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!dec_ctx-&gt;channel_layout)</div><div class="line">            dec_ctx-&gt;channel_layout =</div><div class="line">                av_get_default_channel_layout(dec_ctx-&gt;channels);</div><div class="line">        <span class="built_in">snprintf</span>(args, <span class="keyword">sizeof</span>(args),</div><div class="line">                <span class="string">"time_base=%d/%d:sample_rate=%d:sample_fmt=%s:channel_layout=0x%"</span>PRIx64,</div><div class="line">                dec_ctx-&gt;time_base.num, dec_ctx-&gt;time_base.den, dec_ctx-&gt;sample_rate,</div><div class="line">                av_get_sample_fmt_name(dec_ctx-&gt;sample_fmt),</div><div class="line">                dec_ctx-&gt;channel_layout);</div><div class="line">        ret = avfilter_graph_create_filter(&amp;buffersrc_ctx, buffersrc, <span class="string">"in"</span>,</div><div class="line">                args, <span class="literal">NULL</span>, filter_graph);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot create audio buffer source\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        ret = avfilter_graph_create_filter(&amp;buffersink_ctx, buffersink, <span class="string">"out"</span>,</div><div class="line">                <span class="literal">NULL</span>, <span class="literal">NULL</span>, filter_graph);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot create audio buffer sink\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        ret = av_opt_set_bin(buffersink_ctx, <span class="string">"sample_fmts"</span>,</div><div class="line">                (<span class="keyword">uint8_t</span>*)&amp;enc_ctx-&gt;sample_fmt, <span class="keyword">sizeof</span>(enc_ctx-&gt;sample_fmt),</div><div class="line">                AV_OPT_SEARCH_CHILDREN);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot set output sample format\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        ret = av_opt_set_bin(buffersink_ctx, <span class="string">"channel_layouts"</span>,</div><div class="line">                (<span class="keyword">uint8_t</span>*)&amp;enc_ctx-&gt;channel_layout,</div><div class="line">                <span class="keyword">sizeof</span>(enc_ctx-&gt;channel_layout), AV_OPT_SEARCH_CHILDREN);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot set output channel layout\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        ret = av_opt_set_bin(buffersink_ctx, <span class="string">"sample_rates"</span>,</div><div class="line">                (<span class="keyword">uint8_t</span>*)&amp;enc_ctx-&gt;sample_rate, <span class="keyword">sizeof</span>(enc_ctx-&gt;sample_rate),</div><div class="line">                AV_OPT_SEARCH_CHILDREN);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cannot set output sample rate\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ret = AVERROR_UNKNOWN;</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* Endpoints for the filter graph. */</span></div><div class="line">    outputs-&gt;name       = av_strdup(<span class="string">"in"</span>);</div><div class="line">    outputs-&gt;filter_ctx = buffersrc_ctx;</div><div class="line">    outputs-&gt;pad_idx    = <span class="number">0</span>;</div><div class="line">    outputs-&gt;next       = <span class="literal">NULL</span>;</div><div class="line">    inputs-&gt;name       = av_strdup(<span class="string">"out"</span>);</div><div class="line">    inputs-&gt;filter_ctx = buffersink_ctx;</div><div class="line">    inputs-&gt;pad_idx    = <span class="number">0</span>;</div><div class="line">    inputs-&gt;next       = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (!outputs-&gt;name || !inputs-&gt;name) &#123;</div><div class="line">        ret = AVERROR(ENOMEM);</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((ret = avfilter_graph_parse_ptr(filter_graph, filter_spec,</div><div class="line">                    &amp;inputs, &amp;outputs, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    <span class="keyword">if</span> ((ret = avfilter_graph_config(filter_graph, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    <span class="comment">/* Fill FilteringContext */</span></div><div class="line">    fctx-&gt;buffersrc_ctx = buffersrc_ctx;</div><div class="line">    fctx-&gt;buffersink_ctx = buffersink_ctx;</div><div class="line">    fctx-&gt;filter_graph = filter_graph;</div><div class="line">end:</div><div class="line">    avfilter_inout_free(&amp;inputs);</div><div class="line">    avfilter_inout_free(&amp;outputs);</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init_filters</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *filter_spec;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    filter_ctx = av_malloc_array(ifmt_ctx-&gt;nb_streams, <span class="keyword">sizeof</span>(*filter_ctx));</div><div class="line">    <span class="keyword">if</span> (!filter_ctx)</div><div class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i++) &#123;</div><div class="line">        filter_ctx[i].buffersrc_ctx  = <span class="literal">NULL</span>;</div><div class="line">        filter_ctx[i].buffersink_ctx = <span class="literal">NULL</span>;</div><div class="line">        filter_ctx[i].filter_graph   = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">if</span> (!(ifmt_ctx-&gt;streams[i]-&gt;codec-&gt;codec_type == AVMEDIA_TYPE_AUDIO</div><div class="line">                || ifmt_ctx-&gt;streams[i]-&gt;codec-&gt;codec_type == AVMEDIA_TYPE_VIDEO))</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        <span class="keyword">if</span> (ifmt_ctx-&gt;streams[i]-&gt;codec-&gt;codec_type == AVMEDIA_TYPE_VIDEO)</div><div class="line">            filter_spec = <span class="string">"null"</span>; <span class="comment">/* passthrough (dummy) filter for video */</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">            filter_spec = <span class="string">"anull"</span>; <span class="comment">/* passthrough (dummy) filter for audio */</span></div><div class="line">        ret = init_filter(&amp;filter_ctx[i], ifmt_ctx-&gt;streams[i]-&gt;codec,</div><div class="line">                ofmt_ctx-&gt;streams[i]-&gt;codec, filter_spec);</div><div class="line">        <span class="keyword">if</span> (ret)</div><div class="line">            <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">encode_write_frame</span><span class="params">(AVFrame *filt_frame, <span class="keyword">unsigned</span> <span class="keyword">int</span> stream_index, <span class="keyword">int</span> *got_frame)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">int</span> got_frame_local;</div><div class="line">    AVPacket enc_pkt;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    Encode a frame of video.</span></div><div class="line"><span class="comment">    Takes input raw video data from frame and writes the next output packet, if available, to avpkt.</span></div><div class="line"><span class="comment">    The output packet does not necessarily contain data for the most recent frame,</span></div><div class="line"><span class="comment">     as encoders can delay and reorder input frames internally as needed.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">    avpkt:	output AVPacket. The user can supply an output buffer by setting avpkt-&gt;data and avpkt-&gt;size prior to calling the function,</span></div><div class="line"><span class="comment">    but if the size of the user-provided data is not large enough, encoding will fail.</span></div><div class="line"><span class="comment">    All other AVPacket fields will be reset by the encoder using av_init_packet().</span></div><div class="line"><span class="comment">    If avpkt-&gt;data is NULL, the encoder will allocate it. The encoder will set avpkt-&gt;size to the size of the output packet.</span></div><div class="line"><span class="comment">    The returned data (if any) belongs to the caller, he is responsible for freeing it.</span></div><div class="line"><span class="comment">    */</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    Encode a frame of audio.</span></div><div class="line"><span class="comment">    Takes input samples from frame and writes the next output packet, if available, to avpkt.</span></div><div class="line"><span class="comment">    The output packet does not necessarily contain data for the most recent frame,</span></div><div class="line"><span class="comment">    as encoders can delay, split, and combine input frames internally as needed.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">int</span> (*enc_func)(AVCodecContext *, AVPacket *, <span class="keyword">const</span> AVFrame *, <span class="keyword">int</span> *) =</div><div class="line">        (ifmt_ctx-&gt;streams[stream_index]-&gt;codec-&gt;codec_type ==</div><div class="line">         AVMEDIA_TYPE_VIDEO) ? avcodec_encode_video2 : avcodec_encode_audio2;</div><div class="line">    <span class="keyword">if</span> (!got_frame)</div><div class="line">        got_frame = &amp;got_frame_local;</div><div class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"Encoding frame\n"</span>);</div><div class="line">    <span class="comment">/* encode filtered frame */</span></div><div class="line">    enc_pkt.data = <span class="literal">NULL</span>;</div><div class="line">    enc_pkt.size = <span class="number">0</span>;</div><div class="line">    av_init_packet(&amp;enc_pkt);</div><div class="line">    ret = enc_func(ofmt_ctx-&gt;streams[stream_index]-&gt;codec, &amp;enc_pkt,</div><div class="line">            filt_frame, got_frame);</div><div class="line">    av_frame_free(&amp;filt_frame);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    <span class="keyword">if</span> (!(*got_frame))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="comment">/* prepare packet for muxing */</span></div><div class="line">    enc_pkt.stream_index = stream_index;</div><div class="line">    av_packet_rescale_ts(&amp;enc_pkt,</div><div class="line">                         ofmt_ctx-&gt;streams[stream_index]-&gt;codec-&gt;time_base,</div><div class="line">                         ofmt_ctx-&gt;streams[stream_index]-&gt;time_base);</div><div class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_DEBUG, <span class="string">"Muxing frame\n"</span>);</div><div class="line">    <span class="comment">/* mux encoded frame */</span></div><div class="line">    ret = av_interleaved_write_frame(ofmt_ctx, &amp;enc_pkt);</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 处理视频帧，并编码保存到文件中</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">filter_encode_write_frame</span><span class="params">(AVFrame *frame, <span class="keyword">unsigned</span> <span class="keyword">int</span> stream_index)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    AVFrame *filt_frame;</div><div class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"Pushing decoded frame to filters\n"</span>);</div><div class="line">    <span class="comment">/* push the decoded frame into the filtergraph */</span></div><div class="line">    ret = av_buffersrc_add_frame_flags(filter_ctx[stream_index].buffersrc_ctx,</div><div class="line">            frame, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Error while feeding the filtergraph\n"</span>);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* pull filtered frames from the filtergraph */</span></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        filt_frame = av_frame_alloc();</div><div class="line">        <span class="keyword">if</span> (!filt_frame) &#123;</div><div class="line">            ret = AVERROR(ENOMEM);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"Pulling filtered frame from filters\n"</span>);</div><div class="line">        ret = av_buffersink_get_frame(filter_ctx[stream_index].buffersink_ctx,</div><div class="line">                filt_frame);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">/* if no more frames for output - returns AVERROR(EAGAIN)</span></div><div class="line"><span class="comment">             * if flushed and no more frames for output - returns AVERROR_EOF</span></div><div class="line"><span class="comment">             * rewrite retcode to 0 to show it as normal procedure completion</span></div><div class="line"><span class="comment">             */</span></div><div class="line">            <span class="keyword">if</span> (ret == AVERROR(EAGAIN) || ret == AVERROR_EOF)</div><div class="line">                ret = <span class="number">0</span>;</div><div class="line">            av_frame_free(&amp;filt_frame);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        filt_frame-&gt;pict_type = AV_PICTURE_TYPE_NONE;</div><div class="line">        ret = encode_write_frame(filt_frame, stream_index, <span class="literal">NULL</span>);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 冲洗最后的数据。</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">flush_encoder</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> stream_index)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">int</span> got_frame;</div><div class="line">    <span class="keyword">if</span> (!(ofmt_ctx-&gt;streams[stream_index]-&gt;codec-&gt;codec-&gt;capabilities &amp;</div><div class="line">                AV_CODEC_CAP_DELAY))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"Flushing stream #%u encoder\n"</span>, stream_index);</div><div class="line">        ret = encode_write_frame(<span class="literal">NULL</span>, stream_index, &amp;got_frame);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">if</span> (!got_frame)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    AVPacket packet = &#123; .data = <span class="literal">NULL</span>, .size = <span class="number">0</span> &#125;;</div><div class="line">    AVFrame *frame = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">enum</span> AVMediaType type;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> stream_index;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">int</span> got_frame;</div><div class="line">    <span class="keyword">int</span> (*dec_func)(AVCodecContext *, AVFrame *, <span class="keyword">int</span> *, <span class="keyword">const</span> AVPacket *);</div><div class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Usage: %s &lt;input file&gt; &lt;output file&gt;\n"</span>, argv[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    av_register_all();</div><div class="line">    avfilter_register_all();</div><div class="line">    <span class="keyword">if</span> ((ret = open_input_file(argv[<span class="number">1</span>])) &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    <span class="keyword">if</span> ((ret = open_output_file(argv[<span class="number">2</span>])) &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    <span class="keyword">if</span> ((ret = init_filters()) &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">goto</span> end;</div><div class="line">    <span class="comment">/* read all packets */</span></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span> ((ret = av_read_frame(ifmt_ctx, &amp;packet)) &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        stream_index = packet.stream_index;</div><div class="line">        type = ifmt_ctx-&gt;streams[packet.stream_index]-&gt;codec-&gt;codec_type;</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_DEBUG, <span class="string">"Demuxer gave frame of stream_index %u\n"</span>,</div><div class="line">                stream_index);</div><div class="line">        <span class="keyword">if</span> (filter_ctx[stream_index].filter_graph) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_DEBUG, <span class="string">"Going to reencode&amp;filter the frame\n"</span>);</div><div class="line">            frame = av_frame_alloc();</div><div class="line">            <span class="keyword">if</span> (!frame) &#123;</div><div class="line">                ret = AVERROR(ENOMEM);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//Convert valid timing fields (timestamps / durations) in a packet from one timebase to another.</span></div><div class="line">            av_packet_rescale_ts(&amp;packet,</div><div class="line">                                 ifmt_ctx-&gt;streams[stream_index]-&gt;time_base,</div><div class="line">                                 ifmt_ctx-&gt;streams[stream_index]-&gt;codec-&gt;time_base);</div><div class="line">            <span class="comment">//Decode the video frame of size avpkt-&gt;size from avpkt-&gt;data into picture.</span></div><div class="line">            <span class="comment">// Decode the audio frame of size avpkt-&gt;size from avpkt-&gt;data into frame</span></div><div class="line">            dec_func = (type == AVMEDIA_TYPE_VIDEO) ? avcodec_decode_video2 :</div><div class="line">                avcodec_decode_audio4;</div><div class="line">            ret = dec_func(ifmt_ctx-&gt;streams[stream_index]-&gt;codec, frame,</div><div class="line">                    &amp;got_frame, &amp;packet);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                av_frame_free(&amp;frame);</div><div class="line">                av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Decoding failed\n"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 解码处视频音频数据后-&gt;过滤器处理-&gt;编码处理-&gt;mutex-&gt;文件</span></div><div class="line">            <span class="keyword">if</span> (got_frame) &#123;</div><div class="line">                frame-&gt;pts = av_frame_get_best_effort_timestamp(frame);</div><div class="line">                ret = filter_encode_write_frame(frame, stream_index);</div><div class="line">                av_frame_free(&amp;frame);</div><div class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">                    <span class="keyword">goto</span> end;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                av_frame_free(&amp;frame);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/* remux this frame without reencoding */</span></div><div class="line">            <span class="comment">// Convert valid timing fields (timestamps / durations) in a packet from one timebase to another.</span></div><div class="line">            av_packet_rescale_ts(&amp;packet,</div><div class="line">                                 ifmt_ctx-&gt;streams[stream_index]-&gt;time_base,</div><div class="line">                                 ofmt_ctx-&gt;streams[stream_index]-&gt;time_base);</div><div class="line"></div><div class="line">            <span class="comment">// Write a packet to an output media file ensuring correct interleaving.</span></div><div class="line">            <span class="comment">/*</span></div><div class="line"><span class="comment">        This function will buffer the packets internally as needed to make sure the packets in the output file are properly interleaved</span></div><div class="line"><span class="comment">        in the order of increasing dts.Callers doing their own interleaving should call av_write_frame() instead of this function.</span></div><div class="line"><span class="comment">        Using this function instead of av_write_frame() can give muxers advance knowledge of future packets, improving e.g.</span></div><div class="line"><span class="comment">        the behaviour of the mp4 muxer for VFR content in fragmenting mode.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">            ret = av_interleaved_write_frame(ofmt_ctx, &amp;packet);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">                <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        av_free_packet(&amp;packet);</div><div class="line">    &#125; <span class="comment">// while</span></div><div class="line">    <span class="comment">/* flush filters and encoders */</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i++) &#123;</div><div class="line">        <span class="comment">/* flush filter */</span></div><div class="line">        <span class="keyword">if</span> (!filter_ctx[i].filter_graph)</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        ret = filter_encode_write_frame(<span class="literal">NULL</span>, i);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Flushing filter failed\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/* flush encoder */</span></div><div class="line">        ret = flush_encoder(i);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Flushing encoder failed\n"</span>);</div><div class="line">            <span class="keyword">goto</span> end;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    Write the stream trailer to an output media file and free the file private data.</span></div><div class="line"><span class="comment">    May only be called after a successful call to avformat_write_header.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    av_write_trailer(ofmt_ctx);</div><div class="line">end:</div><div class="line">    av_free_packet(&amp;packet);</div><div class="line">    av_frame_free(&amp;frame);</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i++) &#123;</div><div class="line">        avcodec_close(ifmt_ctx-&gt;streams[i]-&gt;codec);</div><div class="line">        <span class="keyword">if</span> (ofmt_ctx &amp;&amp; ofmt_ctx-&gt;nb_streams &gt; i &amp;&amp; ofmt_ctx-&gt;streams[i] &amp;&amp; ofmt_ctx-&gt;streams[i]-&gt;codec)</div><div class="line">            avcodec_close(ofmt_ctx-&gt;streams[i]-&gt;codec);</div><div class="line">        <span class="keyword">if</span> (filter_ctx &amp;&amp; filter_ctx[i].filter_graph)</div><div class="line">            avfilter_graph_free(&amp;filter_ctx[i].filter_graph);</div><div class="line">    &#125;</div><div class="line">    av_free(filter_ctx);</div><div class="line">    avformat_close_input(&amp;ifmt_ctx);</div><div class="line">    <span class="keyword">if</span> (ofmt_ctx &amp;&amp; !(ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE))</div><div class="line">        avio_closep(&amp;ofmt_ctx-&gt;pb);</div><div class="line">    avformat_free_context(ofmt_ctx);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Error occurred: %s\n"</span>, av_err2str(ret));</div><div class="line">    <span class="keyword">return</span> ret ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/">FFmpeg</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-ffmpeg-avfilter" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/19/ffmpeg-avfilter/" class="article-date">
      <time datetime="2017-09-19T11:29:12.000Z" itemprop="datePublished">2017-09-19</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/19/ffmpeg-avfilter/">ffmpeg avfilter</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <ol>
<li>Scale</li>
</ol>
<p>Scale 保存DAR不变，改变SAR.并且如果输入流的格式不等于下一个filter的输入格式，scale会自动转换格式。</p>
<p><code>scale=w=200:h=100</code>转到200*100<br><code>scale=200:100</code><br><code>scale=qcif</code> 变成1/4</p>
<ol>
<li><p>format<br>把输入文件转换到指定的像素格式。<br><code>ffmpeg -i xxx.mp4 -vf format=yuv444p out7.mp4</code><br>把一个420p转换到444p.</p>
</li>
<li><p>movie， amovie</p>
</li>
<li><p>setpts ,asetpts<br>修改输入frame的PTS。</p>
</li>
<li><p>crop<br>将输入视频剪切到指定的宽高。</p>
</li>
</ol>
<ul>
<li>w,h,out_w,out_h 输出视频的宽高。默认是iw,ih.只在一开始的时候计算一次。</li>
<li>x,y : 从输入视频的那个位置开始剪切。每帧都会计算一次。</li>
<li>keep_aspect:是否保持宽高比不变。</li>
<li>exact:是否使用精确的剪切采样，默认不开启就是使用近视值。<br><code>ffmpeg -i xxx.mp4 -vf crop=100:100:12:34 out11.mp4</code></li>
</ul>
<p><code>ffmpeg -i test.mp4 -vf &quot;crop=in_w/2:in_h/2:(in_w-out_w)/2+((in_w-out_w)/2)*sin(t*10):(in_h-out_h)/2 +((in_h-out_h)/2)*sin(t*13)&quot; out12.mp4</code> 这个输出的视频会有摄像头晃动的效果。</p>
<ol>
<li>slip<br>把输入分成多个相同的输出。需要有个指定输出数量的的参数。默认是2.<br><code>[in] split [out0][out1]</code> .</li>
</ol>
<p><code>ffmpeg -i test.mp4 -filter_complex asplit=5 11.mp4</code>  这条命令输出的视频包含5个音频流。</p>
<ol>
<li><p>hflip<br>水平翻转输入视频。<br><code>ffmpeg -i test.mp4 -vf hflip 11.mp4</code> 这个很像录制时候的镜像功能。</p>
</li>
<li><p>pad<br>对输入的图片添加边框，并把原来的输入放到x,y参数的位置。</p>
</li>
</ol>
<p><code>ffmpeg -i test.mp4 -vf &quot;pad=2*iw:2*ih:ow-iw:oh-ih&quot; 11.mp4</code> 如下图，把原来视频放大两倍，把输入视频放到右下角。屌屌的。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fjp3mc7uraj30o819qn80.jpg" alt=""></p>
<ol>
<li>overlay<br>把一个视频放到另一个上。有两个输入一个输出。第一个输入作为main，第二个覆盖到上面。</li>
</ol>
<ul>
<li>x,y : 设置上面视频的坐标。</li>
<li>eof_action:第二个视频结束的时候，如何处理。repeat 重复最后一帧;endall 结束全部；pass main视频继续。</li>
<li>shortest: 当最短的输入流结束的时候强制结束输出。默认0.</li>
<li>format: 设置输出视频的格式。yuv420,yuv422,yuv444,rgb,grgb,auto,默认是yuv420</li>
<li><p>repeatlasr:强制绘制overlay最后一帧直到结束。默认1.</p>
</li>
<li><p>加水印<br><code>ffmpeg -i input -i logo -filter_complex &#39;overlay=10:main_h-overlay_h-10&#39; output</code></p>
</li>
<li><p>加两个水印<br><code>ffmpeg -i input -i logo1 -i logo2 -filter_complex &#39;overlay=x=10:y=H-h-10,overlay=x=W-w-10:y=H-h-10&#39; output</code></p>
</li>
</ul>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fjp3mys9nkj31kw0zmqev.jpg" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/">FFmpeg</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-H-264-原理知识" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/14/H-264-原理知识/" class="article-date">
      <time datetime="2017-08-14T12:34:13.000Z" itemprop="datePublished">2017-08-14</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/14/H-264-原理知识/">H.264 原理知识</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>今天 学习一下h.264 编码 原理 记录一下。</p>
<blockquote>
<p> <a href="http://simplecodesky.com/2016/11/15/深入浅出理解视频编码H264结构/" target="_blank" rel="external">深入浅出理解视频编码H264结构</a> 讲解 h.264的过程原理。<br><a href="http://www.samirchen.com/video-concept/" target="_blank" rel="external">关于视频的一些概念</a> 这个主要讲解一些基本的概念。<br><a href="http://silencewt.github.io/2015/04/29/YUV和RGB格式分析/" target="_blank" rel="external">YUV和RGB格式分析</a>  这个主要讲YUV 原理很透彻。<br><a href="https://mp.weixin.qq.com/s/BmGmbWUHhKV_a2BoKrrY-A" target="_blank" rel="external">数字视频基础知识—颜色空间</a>  j讲解RGB 和YUV的由来，原理，互转。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/">FFmpeg</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-mac-ffmpeg-开发环境设置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/03/mac-ffmpeg-开发环境设置/" class="article-date">
      <time datetime="2017-08-03T11:19:20.000Z" itemprop="datePublished">2017-08-03</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/03/mac-ffmpeg-开发环境设置/">mac ffmpeg 开发环境设置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="mac-ffmpeg-开发环境设置"><a href="#mac-ffmpeg-开发环境设置" class="headerlink" title="mac-ffmpeg-开发环境设置"></a>mac-ffmpeg-开发环境设置</h1><p>#2017/ffmpeg#</p>
<ol>
<li>Mac 上安装FFmpeg<br>最简单的办法：<code>brew install ffmpeg</code></li>
</ol>
<p>安装完成后 执行<code>ffmpeg</code><br>[image:9E5F4C3E-BB3A-4021-9977-7E1E5C8CAED1-602-00002577A16B4DCD/C6E830EE-026A-4022-AF43-17285995FBC4.png]</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fi6rgott4jj30hc088dh6.jpg" alt=""></p>
<p>代表安装好了。<br>安装完成后可以在<code>/usr/local/Cellar/ffmpeg/3.3.3/lib</code> 找到动态库文件。<br>[image:D5EC1DAC-4F30-48A5-AC39-EF05F542B360-602-000025A461E14647/66DA3B7E-6CDA-400B-96B3-E2C22A001F41.png]<br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fi6rhflva5j30lk05a0tw.jpg" alt=""></p>
<ol>
<li>使用Xcode 创建一个command-lIne 工程</li>
</ol>
<ul>
<li><p>导入ffmpeg动态库：添加第三方库，选择<code>/usr/local/Cellar/ffmpeg/3.3.3/lib</code> 路径下的动态库文件。</p>
</li>
<li><p>设置Header search path<br>设置为<code>/usr/local/include</code> 递归查找<br>[image:C9D8383C-66B6-4448-8DB8-7D27D1C33336-602-000025CC3D567C86/5BD566B9-92F8-4CAF-BC76-FD5D4FD3137B.png]</p>
</li>
</ul>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fi6rhjv0m1j31h40gwdjx.jpg" alt=""></p>
<ol>
<li>测试一下</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">// insert code here...</div><div class="line"></div><div class="line">avcodec_register_all();</div><div class="line"></div><div class="line">printf(&quot;Hello, World!\n&quot;);</div><div class="line">return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完美运行。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/">FFmpeg</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
    <article id="post-Java-Collections" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/01/Java-Collections/" class="article-date">
      <time datetime="2017-08-01T07:52:55.000Z" itemprop="datePublished">2017-08-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/01/Java-Collections/">Java Collections</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="Hash-Set"><a href="#Hash-Set" class="headerlink" title="Hash Set"></a>Hash Set</h2><ul>
<li><p>Why<br>Linked lists and arrays let you specify the order in which you want to arrange the elements. However, if you are looking for a particular element and don’t remember its position, you need to visit all elements until you find a match. That can be time consuming if the collection contains many elements.If you don’t care about the ordering of the elements, there are data structures that let you find elements much faster. The drawback is that those data structures give you no control over the order in which the elements appear. These data structures organize the elements in an order that is convenient for their own purposes.</p>
</li>
<li><p>What<br>A well-known data structure for finding objects quickly is the hash table. A hash table computes an integer, called the hash code, for each object. A hash code is somehow derived from the instance fields of an object, preferably in such a way that objects with different data yield different codes.<br>If you define your own classes, you are responsible for implementing your own hashCode method—see Chapter 5 for more information. Your implementation needs to be compatible with the equals method: If a.equals(b), then a and b must have the same hash code.<br>What’s important for now is that hash codes can be computed quickly and that the computation depends only on the state of the object that needs to be hashed, not on the other objects in the hash table.<br>In Java, hash tables are implemented as arrays of linked lists. Each list is called a bucket (see Figure 9.10). To find the place of an object in the table, compute its hash code and reduce it modulo the total number of buckets. The resulting number is the index of the bucket that holds the element. For example, if an object has hash code 76268 and there are 128 buckets, then the object is placed in bucket 108 (because the remainder 76268 % 128 is 108). Perhaps you are lucky and there is no other element in that bucket. Then, you simply insert the element into that bucket. Of course, sometimes you will hit a bucket that is already filled. This is called a hash collision. Then, compare the new object with all objects in that bucket to see if it is already present. If the hash codes are reasonably randomly distributed<br>and the number of buckets is large enough, only a few comparisons should be necessary.<br>As of Java SE 8, the buckets change from linked lists into balanced binary trees when they get full. This improves performance if a hash function was poorly chosen and yields many collisions, or if malicious code tries to flood a hash table with many values that have identical hash codes.<br>If you want more control over the performance of the hash table, you can specify the initial bucket count.<br>If you know how many elements, approximately, will eventually be in the table, you can set the bucket count. Typically, you should set it to somewhere between 75% and 150% of the expected element count.The standard library uses bucket counts that are powers of 2, with a default of 16. (Any value you supply for the table size is automatically rounded to the next power of 2.)<br>If the hash table gets too full, it needs to be re-hashed. To rehash the table, a table with more buckets is created, all elements are inserted into the new table, and the original table is discarded. The load factor determines when a hash table is rehashed. For example, if the load factor is 0.75<br>Hash tables can be used to implement several important data structures. The simplest among them is the set type. A set is a collection of elements without duplicates. The add method of a set first tries to find the object to be added, and adds it only if it is not yet present.<br>The Java collections library supplies a HashSet class that implements a set based on a hash table. You add elements with the add method. The contains method is re-defined to make a fast lookup to see if an element is already present in the set. It checks only the elements in one bucket and not all elements in the collection.<br>The hash set iterator visits all buckets in turn. Since hashing scatters the elements around in the table, they are visited in a seemingly random order. Y<br>Be careful when you mutate set elements. If the hash code of an element were to change, the element would no longer be in the correct position in the data structure.</p>
</li>
<li><p>How</p>
</li>
</ul>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fi4adxl2yij316a0ksn0n.jpg" alt="xx"><br>[image:15183C4B-6677-4A24-9618-CDD8814713C3-99733-0000D4E2C7846050/71F6F54D-B229-435A-AA58-CD4BBF332F8F.png]<br>[image:F3CF5A14-CFFD-47ED-AD94-A911B628BEB9-99733-0000D4E602253D65/031D1D0B-FA2D-485D-8E9A-78D1F66EF359.png]</p>
<h2 id="Tree-Sets"><a href="#Tree-Sets" class="headerlink" title="Tree Sets"></a>Tree Sets</h2><p>红黑树</p>
<h1 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h1><p>A set is a collection that lets you quickly find an existing element. However, to look up an element, you need to have an exact copy of the element to find. That isn’t a very common lookup—usually, you have some key information, and you want to look up the associated element. The map data structure serves that purpose. A map stores key/value pairs. You can find a value if you provide the key.</p>
<h2 id="Basic-Map-Operations"><a href="#Basic-Map-Operations" class="headerlink" title="Basic Map Operations"></a>Basic Map Operations</h2><p>The Java library supplies two general-purpose implementations for maps: HashMap and TreeMap. Both classes implement the Map interface.<br>A hash map hashes the keys, and a tree map uses an ordering on the keys to organize them in a search tree. The hash or comparison function is applied only to the keys. The values associated with the keys are not hashed or compared.</p>
<p>[image:8857B90A-D770-4DAF-BC2B-2C9A27777A94-99733-0000E0AC95747AF4/242DE8D1-4249-4B78-84BB-BD4C2A603002.png]<br>[image:6C44D47A-E186-4C46-BB09-26D3DC2A972E-99733-0000E0AEC12ACFE1/2CA79C2D-7AE3-4331-BA70-95A3AEC9CB81.png]<br>[image:45244C03-80B8-4B68-8FF1-2C45967B4756-99733-0000E0B0984E142C/E7EA3A23-940A-427A-B931-7F28E87CC843.png]</p>
<p>? As with sets, hashing is usually a bit faster, and it is the preferred choice if you don’t need to visit the keys in sorted order.</p>
<p>Keys must be unique.</p>
<p>The easiest way of iterating over the keys and values of a map is the forEach method.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">scores.forEach((k, v) -&gt;</div><div class="line">System.out.println(&quot;key=&quot; + k + &quot;, value=&quot; + v));</div></pre></td></tr></table></figure>
<h2 id="Updating-Map-Entries"><a href="#Updating-Map-Entries" class="headerlink" title="Updating Map Entries"></a>Updating Map Entries</h2><p>A tricky part of dealing with maps is updating an entry. Normally, you get the old value associated with a key, update it, and put back the updated value. But you have to worry about the special case of the first occurrence of a key. Consider using a map for counting how often a word occurs in a file.<br>[image:687826A7-BC31-481A-B489-76EB1D50F8F6-99733-0000E12308C23344/C455ADCD-2B70-4A88-B772-93F9003DB589.png]<br>[image:0EFAF124-779E-4C14-BD71-54CA250D84D3-99733-0000E126D82C4D50/59F0842A-0440-4A27-9FE3-2C28C50CE7E0.png]</p>
<h2 id="Map-Views"><a href="#Map-Views" class="headerlink" title="Map Views"></a>Map Views</h2><p>The collections framework does not consider a map itself as a collection. (Other frameworks for data structures consider a map as a collection of key/value pairs, or as a collection of values indexed by the keys.) However, you can obtain views of the map—objects that implement the Collection interface or one of its subinterfaces.<br>There are three views: the set of keys, the collection of values (which is not a set), and the set of key/value pairs. The keys and key/value pairs form a set because there can be only one copy of a key in a map.</p>
<p>[image:0844892A-BD7B-4135-93BC-EC48F46A8A38-99733-0000E1A5A229A21F/0E26612D-281A-4AA6-8B2F-DE548BEA6DCE.png]<br>[image:65B80FB8-5162-4B6D-8D20-DF0BCA325CD3-99733-0000E1A804646FE8/1FFB0EE4-C09D-4164-BB75-2AA4AD10FF13.png]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Set&lt;K&gt; keySet()</div><div class="line">Collection&lt;V&gt; values()</div><div class="line">Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</div></pre></td></tr></table></figure>
<p>Note that the keySet is not a HashSet or TreeSet, but an object of some other class that implements the Set interface. The Set interface extends the Collection interface. Therefore, you can use a keySet as you would use any collection.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Set&lt;String&gt; keys = map.keySet();</div><div class="line">for (String key : keys) &#123;</div><div class="line">do something with key</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you want to look at both keys and values, you can avoid value lookups by enumerating the entries. Use the following code skeleton:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">for (Map.Entry&lt;String, Employee&gt; entry : staff.entrySet()) &#123;</div><div class="line">String k = entry.getKey();</div><div class="line">Employee v = entry.getValue();</div><div class="line">do something with k, v</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This used to be the most efficient way of visiting all map entries. Nowadays, simply use the forEach method:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">counts.forEach((k, v) -&gt;</div><div class="line">&#123;</div><div class="line">do something with k, v</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>If you invoke the remove method of the iterator on the key set view, you actually remove the key and its associated value from the map. However, you cannot add an element to the key set view.</p>
<h2 id="Weak-Hash-Map"><a href="#Weak-Hash-Map" class="headerlink" title="Weak Hash Map"></a>Weak Hash Map</h2><p>The WeakHashMap class was designed to solve an interesting problem. What happens with a value whose key is no longer used anywhere in your program? Suppose the last reference to a key has gone away. Then, there is no longer any way to refer to the value object. But, as no part of the program has the key any more, the key/value pair cannot be removed from the map. Why can’t the garbage collector remove it? Isn’t it the job of the garbage collector to remove unused objects?</p>
<p>The garbage collector traces live objects. As long as the map object is live, all buckets in it are live and won’t be reclaimed. Thus, your program should take care to remove unused values from long-lived maps. Or, you can use a WeakHashMap instead. This data structure cooperates with the garbage collector to remove key/value pairs when the only reference to the key is the one from the hash table entry.</p>
<p>Here are the inner workings of this mechanism. The WeakHashMap uses weak references to hold keys. A WeakReference object holds a reference to another object—in our case, a hash table key. Objects of this type are treated in a special way by the garbage collector. Normally, if the garbage collector finds that a particular object has no references to it, it simply reclaims the object. However, if the object is reachable only by a WeakReference, the garbage collector still reclaims the object, but places the weak reference that led to it into a queue. The operations of the WeakHashMap periodically check that queue for newly arrived weak references. The arrival of a weak reference in the queue signifies that the key was no longer used by anyone and has been collected. The WeakHashMap then removes the associated entry.</p>
<h2 id="Linked-Hash-Sets-and-Maps"><a href="#Linked-Hash-Sets-and-Maps" class="headerlink" title="Linked Hash Sets and Maps"></a>Linked Hash Sets and Maps</h2><p>The LinkedHashSet and LinkedHashMap classes remember in which order you inserted items. That way, you can avoid the seemingly random order of items in a hash table.</p>
<p>A linked hash map can alternatively use access order, not insertion order, to iterate through the map entries. Every time you call get or put, the affected entry is removed from its current position and placed at the end of the linked list of entries. (Only the position in the linked list of entries is affected, not the hash table bucket. An entry always stays in the bucket that corresponds to the hash code of the key.) To construct such a hash map, call</p>
<p><code>LinkedHashMap&lt;K, V&gt;(initialCapacity, loadFactor, true)</code></p>
<p>Access order is useful for implementing a “least recently used” discipline for a cache. For example, you may want to keep frequently accessed entries in memory and read less frequently accessed objects from a database. When you don’t find an entry in the table, and the table is already pretty full, you can get an iterator into the table and remove the first few elements that it enumerates. Those entries were the least recently used ones.</p>
<p>You can even automate that process. Form a subclass of LinkedHashMap and override the method</p>
<p><code>protected boolean removeEldestEntry(Map.Entry&lt;K, V&gt; eldest)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Map&lt;K, V&gt; cache = new</div><div class="line"></div><div class="line">LinkedHashMap&lt;&gt;(128, 0.75F, true) &#123;</div><div class="line">protected boolean removeEldestEntry(Map.Entry&lt;K, V&gt; eldest) &#123; return size() &gt; 100; &#125;</div><div class="line">&#125;();</div></pre></td></tr></table></figure>
<h2 id="Enumeration-Sets-and-Maps"><a href="#Enumeration-Sets-and-Maps" class="headerlink" title="Enumeration Sets and Maps"></a>Enumeration Sets and Maps</h2><p>The EnumSet is an efficient set implementation with elements that belong to an enumerated type. Since an enumerated type has a finite number of instances, the EnumSet is internally implemented simply as a sequence of bits. A bit is turned on if the corresponding value is present in the set.</p>
<h2 id="Identity-Hash-Maps"><a href="#Identity-Hash-Maps" class="headerlink" title="Identity Hash Maps"></a>Identity Hash Maps</h2><p>The IdentityHashMap has a quite specialized purpose. Here, the hash values for the keys should not be computed by the hashCode method but by the System.identityHashCode</p>
<p>method. That’s the method that Object.hashCode uses to compute a hash code from the object’s memory address. Also, for comparison of objects, the IdentityHashMap uses ==, not equals.</p>
<p>In other words, different key objects are considered distinct even if they have equal contents. This class is useful for implementing object traversal algorithms, such as object serialization, in which you want to keep track of which objects have already been traversed.<br>[image:F3E9D93E-8DEF-463F-B4ED-637D339F03DF-99733-0000E318719653C7/8E1B38F4-1AFB-448A-8A14-3910EDD18F53.png]</p>
<p>[image:01642B6B-A95D-4052-A1DF-FE0B0637E6D3-99733-0000E31B3A6409A3/0E597DF5-4CDC-496D-A3D8-7ACF00ED1641.png]<br>[image:453961B5-2006-4BD5-A469-F7942A522F97-99733-0000E31D304EA9B2/6081FE95-0AB7-4A14-8594-BE19BCD9BD9B.png]<br>[image:E8220DA6-82C3-49CC-BFF4-CE0E64E3AC2C-99733-0000E31FA2E52569/E1C4B724-12DC-4BC2-8536-B8421E0021CD.png]<br>[image:D0C7E335-0E62-4280-986D-9F7B20008C18-99733-0000E322039A5E8E/B7204E99-4718-4D12-9D59-1FFFE109E0A1.png]</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
    <div class="article-content">
      
    </div>
  </div>
  
</article>










  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 Nigo
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '103798003', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>